<!DOCTYPE html>
<html>
<head>
  <title>Projections Control</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <h1>Projections Control</h1>
    <div id="controls">
      <p>Current Cue: <span id="currentCue"></span></p>
      <div id="previews">
        <div>
          <h3>Current</h3>
          <div id="currentPreview" class="preview-box"></div>
        </div>
        <div>
          <h3>Next</h3>
          <div id="nextPreview" class="preview-box"></div>
        </div>
      </div>
      <button onclick="goCue()">GO</button>
      <button onclick="backCue()">BACK</button>
      <button onclick="toggleBlackout()">BLACKOUT</button>
      <button onclick="endShow()">END SHOW</button>
    </div>
  </div>

  <script>
    const cues = {
      RigCheck: ["1.png", "2.png", "3.png", "4.mp4"],
      Trashion: []
    };

    const show = localStorage.getItem("activeShow");
    const cueList = cues[show];
    let currentIndex = 0;
    let blackout = false;

    const currentCueEl = document.getElementById("currentCue");
    const currentPreview = document.getElementById("currentPreview");
    const nextPreview = document.getElementById("nextPreview");

    function updatePreviews() {
      currentCueEl.textContent = `#${currentIndex + 1} â€” ${cueList[currentIndex] || "End"}`;
      updatePreview(currentPreview, cueList[currentIndex]);
      updatePreview(nextPreview, cueList[currentIndex + 1]);
      sendToViewer();
    }

    function updatePreview(container, file) {
      container.innerHTML = "";
      if (!file) return;
      const ext = file.split('.').pop();
      if (ext === 'mp4') {
        const video = document.createElement("video");
        video.src = `assets/${show}/${file}`;
        video.autoplay = true;
        video.loop = true;
        video.muted = true;
        container.appendChild(video);
      } else {
        const img = document.createElement("img");
        img.src = `assets/${show}/${file}`;
        container.appendChild(img);
      }
    }

    function goCue() {
      if (currentIndex < cueList.length - 1) currentIndex++;
      updatePreviews();
    }

    function backCue() {
      if (currentIndex > 0) currentIndex--;
      updatePreviews();
    }

    function toggleBlackout() {
      blackout = !blackout;
      if (blackout) {
        document.body.classList.add("blackout");
      } else {
        document.body.classList.remove("blackout");
      }
      sendToViewer();
    }

    function endShow() {
      window.location.href = "home.html";
    }

    function sendToViewer() {
      const viewer = window.open('', '_blank');
      if (viewer) {
        viewer.postMessage({
          cue: blackout ? "blackout" : cueList[currentIndex],
          show
        }, '*');
      }
    }

    updatePreviews();
  </script>
</body>
</html>
