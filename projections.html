<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Projections</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .preview-container img, .preview-container video {
      max-width: 100%;
      max-height: 200px;
      object-fit: contain;
    }
    .transitions-list {
      margin-top: 2em;
      max-width: 600px;
      background: #222;
      color: #eee;
      padding: 1em;
      border-radius: 8px;
      font-family: monospace;
    }
    .transitions-list h3 {
      margin-top: 0;
      border-bottom: 1px solid #555;
      padding-bottom: 0.5em;
    }
    .transitions-list ul {
      list-style: none;
      padding-left: 0;
    }
    .transitions-list li {
      margin-bottom: 0.8em;
    }
    .transition-name {
      font-weight: bold;
      color: #00d9ff;
    }
    .transition-desc {
      color: #bbb;
      font-style: italic;
      margin-left: 0.5em;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <h1>Projections Control</h1>
    <h3 id="currentCueTitle">Cue 0 (Blank)</h3>

    <div class="preview-container" style="display: flex; gap: 2em;">
      <div>
        <h4>Current Cue Preview</h4>
        <div id="currentPreview"></div>
      </div>
      <div>
        <h4>Next Cue Preview</h4>
        <div id="nextPreview"></div>
      </div>
    </div>

    <div class="button-group">
      <button onclick="prevCue()">Back</button>
      <button onclick="goCue()">GO</button>
      <button onclick="toggleBlackout()">Blackout</button>
      <button onclick="endShow()">End Show</button>
    </div>

    <div class="transitions-list">
      <h3>Available Transitions</h3>
      <ul>
        <li><span class="transition-name">cut</span> — Instant cut with no animation.</li>
        <li><span class="transition-name">fade2</span> — Fade in over 2 seconds.</li>
        <li><span class="transition-name">fade5</span> — Fade in over 5 seconds.</li>
        <li><span class="transition-name">slide</span> — Slide in from the right.</li>
        <li><span class="transition-name">slideLeft</span> — Slide in from the left.</li>
        <li><span class="transition-name">slideRight</span> — Slide in from the right.</li>
        <li><span class="transition-name">slideUp</span> — Slide in from the bottom.</li>
        <li><span class="transition-name">slideDown</span> — Slide in from the top.</li>
        <li><span class="transition-name">dissolve</span> — Crossfade between old and new cues.</li>
        <li><span class="transition-name">zoomIn</span> — Zoom in from smaller scale while fading.</li>
        <li><span class="transition-name">zoomOut</span> — Zoom out while fading away.</li>
        <li><span class="transition-name">flip</span> — Flip in like a card flipping.</li>
        <li><span class="transition-name">blur</span> — Blur in while fading up.</li>
        <li><span class="transition-name">rotate</span> — Rotate in while fading up.</li>
        <li><span class="transition-name">pixelate</span> — Pixelate out old cue, fade in new.</li>
        <li><span class="transition-name">wipe</span> — Wipe reveal from left to right.</li>
      </ul>
    </div>
  </div>

  <script>
    let viewerWindow = window.open("viewer.html", "viewerWindow");
    let currentCueIndex = 0;
    let isBlackout = false;
    let lastCueBeforeBlackout = 0;

    const shows = {
      "RigCheck": [
        { title: "Blank", file: "", transition: "cut" },
        { title: "Slide Cue", file: "1.png", transition: "slide" },
        { title: "Fade In", file: "2.png", transition: "fade2" },
        { title: "Fade Slow", file: "3.png", transition: "fade5" },
        { title: "Dissolve Cue", file: "4.png", transition: "dissolve" },
        { title: "Video Cue", file: "video.mp4", transition: "fade2", autoplay: true, loop: true }
      ],
      "Trashion": [
        { title: "Start", file: "start.png", transition: "fade2" },
        { title: "Walk Video", file: "walk.mp4", transition: "slideRight", autoplay: true, loop: true }
      ]
    };

    const show = localStorage.getItem("currentShow") || "RigCheck";
    const cues = shows[show] || [{ title: "Blank", file: "", transition: "cut" }];

    function getCuePath(cue) {
      return cue.file ? `assets/${show}/${cue.file}` : "";
    }

    function updatePreview(containerId, cue) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      if (!cue || !cue.file) return;

      const path = getCuePath(cue);
      const isVideo = cue.file.endsWith(".mp4");
      const el = isVideo ? document.createElement("video") : document.createElement("img");
      el.src = path;

      if (isVideo) {
        el.autoplay = cue.autoplay ?? true;
        el.loop = cue.loop ?? true;
        el.muted = true;
        el.playsInline = true;
        el.preload = "auto";
        el.addEventListener("canplay", () => el.play());
      }

      container.appendChild(el);
    }

    function updatePreviews() {
      updatePreview("currentPreview", cues[currentCueIndex]);
      updatePreview("nextPreview", cues[currentCueIndex + 1]);
      document.getElementById("currentCueTitle").textContent = `Cue ${currentCueIndex}: ${cues[currentCueIndex].title}`;
    }

    function sendCue(index = currentCueIndex, overrideBlackout = null) {
      if (!viewerWindow || viewerWindow.closed) return;
      const cue = cues[index];
      const transition = cue.transition || "cut";

      viewerWindow.postMessage({
        cue: getCuePath(cue),
        title: cue.title,
        blackout: overrideBlackout ?? isBlackout,
        transition: transition,
        autoplay: cue.autoplay ?? true,
        loop: cue.loop ?? true
      }, "*");
    }

    function goCue() {
      if (isBlackout) toggleBlackout();
      if (currentCueIndex < cues.length - 1) {
        currentCueIndex++;
        updatePreviews();
        sendCue();
      }
    }

    function prevCue() {
      if (currentCueIndex > 0) {
        currentCueIndex--;
        updatePreviews();
        sendCue();
      }
    }

    function toggleBlackout() {
      if (!isBlackout) {
        lastCueBeforeBlackout = currentCueIndex;
        isBlackout = true;
        viewerWindow.postMessage({ blackout: true, transition: "fade2" }, "*");
      } else {
        isBlackout = false;
        updatePreviews();
        sendCue();
      }
    }

    function endShow() {
      window.location.href = "home.html";
    }

    updatePreviews();
    setTimeout(() => sendCue(), 500);
  </script>
</body>
</html>
