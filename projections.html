<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ProjectionsGo - Projections Control</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header>
    <h1>Projections Control Panel</h1>
  </header>
  <main>
    <div id="showSelection">
      <label for="showSelect">Select Show:</label>
      <select id="showSelect"></select>
    </div>
    <div id="cueControls">
      <button id="prevCue">Previous Cue</button>
      <button id="nextCue">Next Cue</button>
      <button id="blackoutCue">Blackout</button>
    </div>
    <div id="previewArea"></div>
  </main>
  <script>
    const users = {
      admin: ['RigCheck', 'Trashion'],
      customer1: ['RigCheck'],
      customer2: ['RigCheck'],
      customer3: ['RigCheck'],
      customer4: ['RigCheck'],
      customer5: ['RigCheck']
    };

    const shows = {
      RigCheck: ['1.png', '2.mp4', '3.png', '4.mp4'],
      Trashion: ['1.mp4', '2.png', '3.mp4']
    };

    const username = localStorage.getItem('username');
    const viewerWindow = window.open('viewer.html', 'viewerWindow');

    if (!username || !users[username]) {
      alert("You are not authorized. Returning to home.");
      window.location.href = 'index.html';
    }

    const showSelect = document.getElementById('showSelect');
    const previewArea = document.getElementById('previewArea');
    let cues = [];
    let currentCueIndex = 0;
    let isBlackout = false;
    let lastCueSrc = "";

    // Populate dropdown
    users[username].forEach(show => {
      const opt = document.createElement("option");
      opt.value = show;
      opt.textContent = show;
      showSelect.appendChild(opt);
    });

    function renderCue(cueFile) {
      const ext = cueFile.split('.').pop().toLowerCase();
      previewArea.innerHTML = "";
      let element;

      if (ext === "mp4") {
        element = document.createElement("video");
        element.src = `assets/${showSelect.value}/${cueFile}`;
        element.autoplay = true;
        element.loop = true;
        element.muted = true;
      } else {
        element = document.createElement("img");
        element.src = `assets/${showSelect.value}/${cueFile}`;
      }

      element.style.maxWidth = "100%";
      element.style.maxHeight = "200px";
      previewArea.appendChild(element);
      sendToViewer(element.src, ext === "mp4" ? "video" : "image");
      lastCueSrc = element.src;
    }

    function sendToViewer(src, type) {
      if (viewerWindow) {
        viewerWindow.postMessage({ type: 'cueChange', src: src, mediaType: type }, '*');
      }
    }

    function blackoutOn() {
      isBlackout = true;
      previewArea.innerHTML = "<h2 style='text-align:center; color:red;'>BLACKOUT</h2>";
      if (viewerWindow) viewerWindow.postMessage({ type: 'cueChange', src: '', mediaType: 'blackout' }, '*');
      document.getElementById('blackoutCue').textContent = "Turn Off Blackout";
    }

    function blackoutOff() {
      isBlackout = false;
      renderCue(cues[currentCueIndex]);
      document.getElementById('blackoutCue').textContent = "Blackout";
    }

    // Load first show
    if (showSelect.options.length > 0) {
      const defaultShow = showSelect.options[0].value;
      cues = shows[defaultShow];
      showSelect.value = defaultShow;
      renderCue(cues[0]);
    }

    showSelect.addEventListener('change', () => {
      const selectedShow = showSelect.value;
      cues = shows[selectedShow];
      currentCueIndex = 0;
      renderCue(cues[currentCueIndex]);
    });

    document.getElementById("prevCue").addEventListener("click", () => {
      if (currentCueIndex > 0) {
        currentCueIndex--;
        renderCue(cues[currentCueIndex]);
      }
    });

    document.getElementById("nextCue").addEventListener("click", () => {
      if (currentCueIndex < cues.length - 1) {
        currentCueIndex++;
        renderCue(cues[currentCueIndex]);
      }
    });

    document.getElementById("blackoutCue").addEventListener("click", () => {
      isBlackout ? blackoutOff() : blackoutOn();
    });
  </script>
</body>
</html>
