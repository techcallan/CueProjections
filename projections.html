<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Projections Control</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .cue-preview {
      max-width: 45%;
      height: auto;
    }
    .cue-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
  </style>
</head>
<body class="main-container">
  <h1>Projections Control Panel</h1>
  
  <div id="showLoaderContainer" style="display:none;">
    <label>Select a show:</label>
    <select id="showSelect">
      <option value="RigCheck">RigCheck</option>
      <option value="Trashion">Trashion</option>
      <!-- Add more shows here -->
    </select>
    <button onclick="loadShow()">Load Show</button>
  </div>

  <h3 id="showTitle"></h3>
  
  <div class="cue-container">
    <div>
      <h3>Current Cue</h3>
      <img id="currentCue" class="cue-preview" src="">
    </div>
    <div>
      <h3>Next Cue</h3>
      <img id="nextCue" class="cue-preview" src="">
    </div>
  </div>

  <div class="button-group">
    <button onclick="prevCue()">Back</button>
    <button onclick="goCue()">GO</button>
    <button onclick="toggleBlackout()" id="blackoutBtn">Blackout</button>
    <button onclick="endShow()">End Show</button>
  </div>

  <script>
    let currentCue = 0;
    let showName = localStorage.getItem('currentShow');
    let cues = [];
    let blackout = false;

    if (!showName) {
      document.getElementById('showLoaderContainer').style.display = 'block';
    } else {
      document.getElementById('showTitle').textContent = `Loaded Show: ${showName}`;
      loadCueList(showName);
    }

    function loadShow() {
      showName = document.getElementById('showSelect').value;
      localStorage.setItem('currentShow', showName);
      localStorage.setItem('currentCue', '0');
      document.getElementById('showLoaderContainer').style.display = 'none';
      document.getElementById('showTitle').textContent = `Loaded Show: ${showName}`;
      loadCueList(showName);
    }

    function loadCueList(show) {
      fetch(`assets/${show}/`)
        .then(() => {
          const exts = ['jpg', 'jpeg', 'png', 'gif', 'mp4'];
          let i = 0;
          cues = [];
          const preload = () => {
            const testImg = new Image();
            testImg.onload = () => {
              cues.push(`assets/${show}/${i}.jpg`);
              i++;
              preload();
            };
            testImg.onerror = () => {
              updateCues();
            };
            testImg.src = `assets/${show}/${i}.jpg`;
          };
          preload();
        })
        .catch(() => alert('Could not load show.'));
    }

    function updateCues() {
      document.getElementById('currentCue').src = cues[currentCue] || '';
      document.getElementById('nextCue').src = cues[currentCue + 1] || '';
      const viewer = window.open('', 'viewerWindow');
      if (viewer) {
        viewer.postMessage({ cue: cues[currentCue] }, '*');
      }
    }

    function goCue() {
      if (currentCue < cues.length - 1) {
        currentCue++;
        updateCues();
      }
    }

    function prevCue() {
      if (currentCue > 0) {
        currentCue--;
        updateCues();
      }
    }

    function toggleBlackout() {
      blackout = !blackout;
      const viewer = window.open('', 'viewerWindow');
      if (viewer) {
        viewer.postMessage({ blackout: blackout }, '*');
      }
      document.getElementById('blackoutBtn').textContent = blackout ? 'Turn Off Blackout' : 'Blackout';
    }

    function endShow() {
      window.location.href = 'home.html';
    }

    window.addEventListener('load', () => {
      currentCue = parseInt(localStorage.getItem('currentCue') || '0');
    });
  </script>
</body>
</html>
