<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Projections Control</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .preview-container img, .preview-container video {
      max-width: 100%;
      max-height: 200px;
      object-fit: contain;
    }
    .button-group {
      margin-top: 1em;
    }
    label {
      margin-right: 0.5em;
    }
    select {
      margin-left: 0.5em;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <h1>Projections Control</h1>
    <h3 id="currentCueTitle">Cue 0 (Blank)</h3>

    <div>
      <label for="transitionSelect">Transition:</label>
      <select id="transitionSelect">
        <option value="cut">Immediate Cut</option>
        <option value="slide">Slide</option>
        <option value="fade2">2 sec Fade</option>
        <option value="fade5">5 sec Fade</option>
        <option value="dissolve">Dissolve</option>
      </select>
    </div>

    <div class="preview-container" style="display:flex; gap: 2em; margin-top: 1em;">
      <div>
        <h4>Current Cue Preview</h4>
        <div id="currentPreview"></div>
      </div>
      <div>
        <h4>Next Cue Preview</h4>
        <div id="nextPreview"></div>
      </div>
    </div>

    <div class="button-group">
      <button onclick="prevCue()">Back</button>
      <button onclick="goCue()">GO</button>
      <button onclick="toggleBlackout()">Blackout</button>
      <button onclick="endShow()">End Show</button>
    </div>
  </div>

  <script>
    let viewerWindow = window.open("viewer.html", "viewerWindow");
    let cues = [];
    let currentCueIndex = 0;
    let isBlackout = false;
    let lastCueBeforeBlackout = 0;

    const shows = {
      "RigCheck": [
        { title: "Blank", fade: 0, file: "" },
        { title: "1",  fade: 1.5, file: "1.png" },
        { title: "2",  fade: 2, file: "2.png" },
        { title: "3", fade: 2, file: "3.png" },
        { title: "Video", fade: 1, file: "4.mp4" },
        { title: "4", fade: 2, file: "5.png" }
      ]
    };

    const show = localStorage.getItem("currentShow") || "RigCheck";
    cues = shows[show] || [{ title: "Blank", fade: 0, file: "" }];

    function getCuePath(cue) {
      return cue.file ? `assets/${show}/${cue.file}` : "";
    }

    function updatePreview(containerId, cue) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      if (!cue || !cue.file) return;

      const path = getCuePath(cue);
      const isVideo = cue.file.toLowerCase().endsWith(".mp4");
      let el;
      if (isVideo) {
        el = document.createElement("video");
        el.src = path;
        el.autoplay = true;
        el.loop = true;
        el.muted = true;
        el.playsInline = true;
        el.preload = "auto";
      } else {
        el = document.createElement("img");
        el.src = path;
        el.alt = cue.title;
      }

      container.appendChild(el);
    }

    function updatePreviews() {
      const current = cues[currentCueIndex];
      const next = cues[currentCueIndex + 1];
      updatePreview("currentPreview", current);
      updatePreview("nextPreview", next);
      document.getElementById("currentCueTitle").textContent = `Cue ${currentCueIndex}: ${current.title}`;
    }

    // Send cue message to viewer, including transition and blackout status
    function sendCue(overrideCueIndex = null, overrideBlackout = null) {
      if (!viewerWindow || viewerWindow.closed) return;
      const index = overrideCueIndex !== null ? overrideCueIndex : currentCueIndex;
      const cue = cues[index];
      const blackoutStatus = overrideBlackout !== null ? overrideBlackout : isBlackout;
      const transitionSelect = document.getElementById("transitionSelect");
      const transition = transitionSelect.value;

      viewerWindow.postMessage({
        cue: blackoutStatus ? null : getCuePath(cue),
        name: blackoutStatus ? "Blackout" : cue.title,
        fade: blackoutStatus ? 2 : cue.fade, // Use 2 seconds fade for blackout fade down
        blackout: blackoutStatus,
        transition: blackoutStatus ? "fade2" : transition
      }, "*");
    }

    function goCue() {
      if (isBlackout) toggleBlackout(); // Disable blackout if active first
      if (currentCueIndex < cues.length - 1) {
        currentCueIndex++;
        updatePreviews();
        sendCue();
      }
    }

    function prevCue() {
      if (currentCueIndex > 0) {
        currentCueIndex--;
        updatePreviews();
        sendCue();
      }
    }

    function toggleBlackout() {
      if (!isBlackout) {
        // Fade to blackout over 2 seconds then send blackout
        lastCueBeforeBlackout = currentCueIndex;
        isBlackout = true;

        // Send fade down transition first, then blackout
        sendCue(currentCueIndex, false); // Send current cue with fade2 for fade out
        setTimeout(() => {
          sendCue(null, true); // Then send blackout
        }, 2000);
      } else {
        // Fade up from blackout to last cue with selected transition
        isBlackout = false;
        updatePreviews();
        sendCue();
      }
    }

    function endShow() {
      window.location.href = "home.html";
    }

    updatePreviews();
    setTimeout(() => sendCue(), 500);
  </script>
</body>
</html>
