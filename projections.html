<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Projections Control</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .cue-preview {
      max-width: 45%;
      height: auto;
    }

    .cue-container {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
  </style>
</head>
<body class="main-container">
  <h1>Projections Control Panel</h1>

  <h3 id="showTitle"></h3>

  <div class="cue-container">
    <div>
      <h3>Current Cue</h3>
      <div id="currentCuePreview" class="cue-preview"></div>
    </div>
    <div>
      <h3>Next Cue</h3>
      <div id="nextCuePreview" class="cue-preview"></div>
    </div>
  </div>

  <div class="button-group">
    <button onclick="prevCue()">Back</button>
    <button onclick="goCue()">GO</button>
    <button onclick="toggleBlackout()" id="blackoutBtn">Blackout</button>
    <button onclick="endShow()">End Show</button>
  </div>

  <script>
    let showName = localStorage.getItem("currentShow") || "RigCheck";
    let cueList = [""]; // cue 0 = blank
    let currentCue = 0;
    let blackout = false;

    document.getElementById("showTitle").innerText = `Loaded Show: ${showName}`;
    openViewer();
    loadCues();

    function loadCues() {
      const basePath = `assets/${showName}/`;
      const formats = ["png", "jpg", "jpeg", "mp4"];
      let index = 1;

      function tryLoadNext() {
        if (index > 99) return updateCues();

        let loaded = false;
        formats.forEach(ext => {
          let path = `${basePath}${index}.${ext}`;
          let img = new Image();
          img.onload = () => {
            if (!loaded) {
              cueList.push(path);
              index++;
              tryLoadNext();
              loaded = true;
            }
          };
          img.onerror = () => {
            // If it's mp4, push it directly as it won't load in Image
            if (ext === "mp4" && !loaded) {
              fetch(path)
                .then(res => {
                  if (res.ok) {
                    cueList.push(path);
                    index++;
                    tryLoadNext();
                  }
                })
                .catch(() => {});
            }
          };
          img.src = path;
        });
      }

      tryLoadNext();
    }

    function updateCues() {
      const current = cueList[currentCue] || "";
      const next = cueList[currentCue + 1] || "";

      renderCue(current, "currentCuePreview");
      renderCue(next, "nextCuePreview");

      // Send to viewer
      const viewer = window.open("viewer.html", "viewerWindow");
      if (viewer) {
        viewer.postMessage({ cue: current, blackout }, "*");
      }
    }

    function renderCue(cuePath, elementId) {
      const el = document.getElementById(elementId);
      el.innerHTML = "";
      if (cuePath.endsWith(".mp4")) {
        const video = document.createElement("video");
        video.src = cuePath;
        video.controls = false;
        video.autoplay = true;
        video.loop = true;
        video.muted = true;
        video.style.maxWidth = "100%";
        el.appendChild(video);
      } else if (cuePath) {
        const img = document.createElement("img");
        img.src = cuePath;
        img.className = "cue-preview";
        el.appendChild(img);
      }
    }

    function goCue() {
      if (currentCue < cueList.length - 1) {
        currentCue++;
        updateCues();
      }
    }

    function prevCue() {
      if (currentCue > 0) {
        currentCue--;
        updateCues();
      }
    }

    function toggleBlackout() {
      blackout = !blackout;
      updateCues();
      document.getElementById("blackoutBtn").innerText = blackout ? "Turn Off Blackout" : "Blackout";
    }

    function endShow() {
      window.location.href = "home.html";
    }

    function openViewer() {
      window.open("viewer.html", "viewerWindow");
    }
  </script>
</body>
</html>
