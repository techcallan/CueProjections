<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Projections Control</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    .preview-container img, .preview-container video {
      max-width: 100%;
      max-height: 200px;
      object-fit: contain;
    }
    #viewerWindow {
      display: none;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <h1>Projections Control</h1>
    <div id="showLoader">
      <label for="showSelect">Load Show:</label>
      <select id="showSelect">
        <option value="">-- Select a show --</option>
      </select>
      <button onclick="loadShow()">Load</button>
    </div>

    <div id="controlPanel" style="display:none;">
      <h3 id="currentCueTitle">Cue 0 (Blank)</h3>

      <div class="preview-container">
        <div>
          <h4>Current Cue Preview</h4>
          <div id="currentPreview"></div>
        </div>
        <div>
          <h4>Next Cue Preview</h4>
          <div id="nextPreview"></div>
        </div>
      </div>

      <div class="button-group">
        <button onclick="prevCue()">Back</button>
        <button onclick="goCue()">GO</button>
        <button onclick="toggleBlackout()">Blackout</button>
        <button onclick="endShow()">End Show</button>
      </div>
    </div>
  </div>

  <script>
    let viewerWindow;
    let cues = [];
    let currentCueIndex = 0;
    let isBlackout = false;
    let lastCueBeforeBlackout = 0;

    const showSelect = document.getElementById("showSelect");

    const shows = {
      "RigCheck": ["1.png", "2.png", "3.png", "4.mp4"],
      "Trashion": []
    };

    window.onload = () => {
      Object.keys(shows).forEach(show => {
        const option = document.createElement("option");
        option.value = show;
        option.textContent = show;
        showSelect.appendChild(option);
      });
    };

    function loadShow() {
      const selectedShow = showSelect.value;
      if (!selectedShow) return alert("Select a show");

      cues = shows[selectedShow].map(file => `assets/${selectedShow}/${file}`);
      cues.unshift(""); // cue 0 = blank
      currentCueIndex = 0;
      updatePreviews();

      document.getElementById("controlPanel").style.display = "block";

      viewerWindow = window.open("viewer.html", "viewerWindow");

      setTimeout(() => {
        sendCue(); // send blank cue initially
      }, 500);
    }

    function updatePreviews() {
      const current = cues[currentCueIndex];
      const next = cues[currentCueIndex + 1];

      updatePreviewElement("currentPreview", current);
      updatePreviewElement("nextPreview", next);
      document.getElementById("currentCueTitle").textContent = `Cue ${currentCueIndex}`;
    }

    function updatePreviewElement(containerId, cuePath) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      if (!cuePath) return;

      const isVideo = cuePath.endsWith(".mp4");

      const el = isVideo ? document.createElement("video") : document.createElement("img");
      el.src = cuePath;
      if (isVideo) {
        el.autoplay = true;
        el.loop = true;
        el.muted = true;
      }
      container.appendChild(el);
    }

    function sendCue() {
      if (!viewerWindow || viewerWindow.closed) {
        alert("Viewer window not open!");
        return;
      }

      const current = cues[currentCueIndex];
      viewerWindow.postMessage({ cue: current, blackout: isBlackout }, "*");
    }

    function goCue() {
      if (isBlackout) toggleBlackout(); // exit blackout on GO

      if (currentCueIndex < cues.length - 1) {
        currentCueIndex++;
        sendCue();
        updatePreviews();
      }
    }

    function prevCue() {
      if (currentCueIndex > 0) {
        currentCueIndex--;
        sendCue();
        updatePreviews();
      }
    }

    function toggleBlackout() {
      if (!isBlackout) {
        lastCueBeforeBlackout = currentCueIndex;
        isBlackout = true;
        viewerWindow.postMessage({ blackout: true }, "*");
      } else {
        isBlackout = false;
        viewerWindow.postMessage({ cue: cues[lastCueBeforeBlackout], blackout: false }, "*");
      }
    }

    function endShow() {
      window.location.href = "home.html";
    }
  </script>
</body>
</html>
