<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Projections - CueProjections</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #111;
      color: #eee;
    }
    .cue-item {
      border: 1px solid #444;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      background-color: #222;
    }
    .cue-preview img, .cue-preview video {
      max-width: 100%;
      max-height: 200px;
    }
    .controls button {
      margin: 5px;
    }
  </style>
</head>
<body>
  <h1>Projections</h1>
  <div id="cueList"></div>
  <button onclick="sendBlackout()">Blackout</button>

  <script>
    const viewerWindow = window.open('', 'viewerWindow');
    const show = localStorage.getItem('currentShow') || 'RigCheck';

    const shows = {
      RigCheck: [
        { title: "Logo", file: "assets/1.png", transition: "fade2" },
        { title: "Intro Video", file: "assets/2.mp4", transition: "fade5", autoplay: true, loop: true },
        { title: "Slide In", file: "assets/3.png", transition: "slide" },
        { title: "Cut Image", file: "assets/5.png", transition: "cut" },
        { title: "Looping Video", file: "assets/4.mp4", transition: "fade2", autoplay: true, loop: true }
      ],
      Trashion: [
        { title: "Opening", file: "assets/opening.mp4", transition: "fade2", autoplay: true, loop: false },
        { title: "Scene Image", file: "assets/scene.png", transition: "slide" }
      ]
    };

    const cues = shows[show] || [];
    const cueListDiv = document.getElementById("cueList");

    cues.forEach((cue, index) => {
      const cueDiv = document.createElement("div");
      cueDiv.className = "cue-item";

      cueDiv.innerHTML = `
        <h3>${cue.title}</h3>
        <div class="cue-preview" id="preview-${index}"></div>
        <div class="controls">
          <button onclick="triggerCue(${index})">Go</button>
        </div>
      `;
      cueListDiv.appendChild(cueDiv);
      updatePreview(`preview-${index}`, cue);
    });

    function triggerCue(index) {
      const cue = cues[index];
      if (viewerWindow) {
        viewerWindow.postMessage({
          cue: cue.file,
          transition: cue.transition || 'fade2',
          autoplay: cue.autoplay ?? true,
          loop: cue.loop ?? true
        }, '*');
      }
    }

    function sendBlackout() {
      if (viewerWindow) {
        viewerWindow.postMessage({ blackout: true }, '*');
      }
    }

    function updatePreview(containerId, cue) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      if (!cue || !cue.file) return;

      const path = cue.file;
      const isVideo = path.endsWith(".mp4");
      const el = isVideo ? document.createElement("video") : document.createElement("img");
      el.src = path;

      if (isVideo) {
        el.autoplay = cue.autoplay ?? true;
        el.loop = cue.loop ?? true;
        el.muted = true;
        el.playsInline = true;
        el.preload = "auto";
        el.style.maxHeight = "200px";
        el.style.maxWidth = "100%";
        el.addEventListener("canplay", () => el.play().catch(() => {}));
      }

      container.appendChild(el);
    }
  </script>
</body>
</html>
