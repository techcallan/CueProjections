<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Viewer</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    html, body {
      margin: 0; padding: 0;
      background-color: black;
      height: 100%; width: 100%;
      overflow: hidden;
    }
    #cueDisplay {
      width: 100%; height: 100%;
      background: black;
      position: relative;
      overflow: hidden;
    }
    #cueDisplay img, #cueDisplay video {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100%; max-height: 100%;
      object-fit: contain;
      opacity: 0;
      transition: opacity 1s ease-in-out, transform 1s ease-in-out, filter 1s ease-in-out;
      backface-visibility: hidden;
    }
    /* Active cue */
    .active {
      opacity: 1 !important;
      z-index: 10;
    }

    /* Transitions */

    /* Slide directions */
    .slide-in-left {
      animation: slideInLeft 1s forwards;
    }
    .slide-in-right {
      animation: slideInRight 1s forwards;
    }
    .slide-in-up {
      animation: slideInUp 1s forwards;
    }
    .slide-in-down {
      animation: slideInDown 1s forwards;
    }

    @keyframes slideInLeft {
      from { transform: translate(calc(-50% + 100vw), -50%); opacity: 0; }
      to { transform: translate(-50%, -50%); opacity: 1; }
    }
    @keyframes slideInRight {
      from { transform: translate(calc(-50% - 100vw), -50%); opacity: 0; }
      to { transform: translate(-50%, -50%); opacity: 1; }
    }
    @keyframes slideInUp {
      from { transform: translate(-50%, calc(-50% + 100vh)); opacity: 0; }
      to { transform: translate(-50%, -50%); opacity: 1; }
    }
    @keyframes slideInDown {
      from { transform: translate(-50%, calc(-50% - 100vh)); opacity: 0; }
      to { transform: translate(-50%, -50%); opacity: 1; }
    }

    /* Zoom */
    .zoom-in {
      animation: zoomIn 1s forwards;
    }
    .zoom-out {
      animation: zoomOut 1s forwards;
    }
    @keyframes zoomIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.7); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    @keyframes zoomOut {
      from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      to { opacity: 0; transform: translate(-50%, -50%) scale(1.3); }
    }

    /* Flip */
    .flip-in {
      animation: flipIn 1s forwards;
      transform-style: preserve-3d;
    }
    @keyframes flipIn {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) rotateY(90deg);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) rotateY(0deg);
      }
    }

    /* Blur */
    .blur-in {
      animation: blurIn 1s forwards;
    }
    @keyframes blurIn {
      from { opacity: 0; filter: blur(10px); }
      to { opacity: 1; filter: blur(0); }
    }

    /* Rotate */
    .rotate-in {
      animation: rotateIn 1s forwards;
    }
    @keyframes rotateIn {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) rotate(-90deg);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) rotate(0deg);
      }
    }

    /* Pixelate */
    .pixelate-in {
      animation: pixelateIn 1s forwards;
      filter: url(#pixelate);
    }
    @keyframes pixelateIn {
      from { opacity: 0; filter: url(#pixelate); }
      to { opacity: 1; filter: none; }
    }

    /* Wipe */
    .wipe-in {
      position: relative;
      overflow: hidden;
    }
    .wipe-in::before {
      content: "";
      position: absolute;
      left: 0; top: 0;
      width: 0;
      height: 100%;
      background: black;
      z-index: 20;
      animation: wipeAnim 1s forwards;
    }
    @keyframes wipeAnim {
      from { width: 100%; }
      to { width: 0; }
    }

  </style>
</head>
<body>
  <div id="cueDisplay"></div>
  <button id="fsBtn" onclick="toggleFullscreen()">Fullscreen</button>

  <script>
    const cueDisplay = document.getElementById("cueDisplay");

    // Store current displayed element for dissolve crossfade
    let currentEl = null;

    function clearDisplay(callback, transition) {
      if (!currentEl) return callback?.();

      if(transition === 'dissolve') {
        // Crossfade: keep both elements and fade old one out, new one fades in in showCue
        currentEl.style.transition = 'opacity 1s ease-in-out';
        currentEl.style.opacity = 0;
        setTimeout(() => {
          if (currentEl && currentEl.parentElement) {
            cueDisplay.removeChild(currentEl);
            currentEl = null;
          }
          callback?.();
        }, 1000);
      } else {
        // Default: fade out old element then remove
        currentEl.style.opacity = 0;
        setTimeout(() => {
          if (currentEl && currentEl.parentElement) {
            cueDisplay.removeChild(currentEl);
            currentEl = null;
          }
          callback?.();
        }, 500);
      }
    }

    function applyTransition(el, type) {
      el.style.transition = "none"; // Reset first

      switch (type) {
        case 'fade2':
          el.style.transition = "opacity 2s ease-in-out";
          el.style.opacity = 0;
          requestAnimationFrame(() => {
            el.style.opacity = 1;
          });
          break;
        case 'fade5':
          el.style.transition = "opacity 5s ease-in-out";
          el.style.opacity = 0;
          requestAnimationFrame(() => {
            el.style.opacity = 1;
          });
          break;
        case 'slide':
        case 'slideRight':
          el.classList.add('slide-in-right');
          break;
        case 'slideLeft':
          el.classList.add('slide-in-left');
          break;
        case 'slideUp':
          el.classList.add('slide-in-up');
          break;
        case 'slideDown':
          el.classList.add('slide-in-down');
          break;
        case 'zoomIn':
          el.classList.add('zoom-in');
          break;
        case 'zoomOut':
          el.classList.add('zoom-out');
          break;
        case 'flip':
          el.classList.add('flip-in');
          break;
        case 'blur':
          el.classList.add('blur-in');
          break;
        case 'rotate':
          el.classList.add('rotate-in');
          break;
        case 'pixelate':
          el.classList.add('pixelate-in');
          break;
        case 'wipe':
          el.classList.add('wipe-in');
          break;
        case 'cut':
          el.style.opacity = 1;
          break;
        case 'dissolve':
          // For dissolve, we do crossfade: new el starts at 0 opacity and transitions to 1
          el.style.opacity = 0;
          requestAnimationFrame(() => {
            el.style.transition = "opacity 1s ease-in-out";
            el.style.opacity = 1;
          });
          break;
        default:
          el.style.opacity = 1;
          break;
      }
    }

    function showCue(data) {
      if (data.blackout) {
        // Blackout immediately - remove all elements and add black div
        cueDisplay.innerHTML = "";
        const blackout = document.createElement("div");
        blackout.style.background = "black";
        blackout.style.position = "absolute";
        blackout.style.top = "0";
        blackout.style.left = "0";
        blackout.style.width = "100%";
        blackout.style.height = "100%";
        blackout.style.opacity = 1;
        cueDisplay.appendChild(blackout);
        currentEl = blackout;
        return;
      }

      const isVideo = data.cue.endsWith(".mp4");
      const el = isVideo ? document.createElement("video") : document.createElement("img");
      el.src = data.cue;

      if (isVideo) {
        el.autoplay = data.autoplay ?? true;
        el.loop = data.loop ?? true;
        el.muted = true;
        el.playsInline = true;
        el.preload = "auto";
        el.addEventListener("canplay", () => el.play());
      }

      el.style.opacity = 0;
      el.style.zIndex = 5;
      el.style.position = "absolute";
      el.style.top = "50%";
      el.style.left = "50%";
      el.style.transform = "translate(-50%, -50%)";
      el.style.maxWidth = "100%";
      el.style.maxHeight = "100%";
      el.style.objectFit = "contain";

      cueDisplay.appendChild(el);

      applyTransition(el, data.transition || "fade2");

      // Update current element reference
      currentEl = el;
    }

    window.addEventListener("message", (event) => {
      const data = event.data;
      clearDisplay(() => showCue(data), data.transition);
    });

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        document.getElementById("fsBtn").style.display = "none";
      } else {
        document.exitFullscreen();
        document.getElementById("fsBtn").style.display = "block";
      }
    }
  </script>
</body>
</html>


