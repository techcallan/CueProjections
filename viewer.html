<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Viewer</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: black;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    #cueDisplay {
      width: 100%;
      height: 100%;
      background: black;
      position: relative;
      overflow: hidden;
    }

    .media {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      opacity: 0;
      z-index: 0;
    }

    .active {
      opacity: 1 !important;
      z-index: 2;
    }

    .fade2 { transition: opacity 2s ease-in-out; }
    .fade5 { transition: opacity 5s ease-in-out; }

    @keyframes slideRight { from { transform: translate(100%, -50%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
    @keyframes slideLeft { from { transform: translate(-200%, -50%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
    @keyframes slideUp { from { transform: translate(-50%, -200%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
    @keyframes slideDown { from { transform: translate(-50%, 100%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }

    .slideRight { animation: slideRight 1s forwards; }
    .slideLeft { animation: slideLeft 1s forwards; }
    .slideUp { animation: slideUp 1s forwards; }
    .slideDown { animation: slideDown 1s forwards; }

    @keyframes zoomIn { from { transform: scale(0.7) translate(-50%, -50%); opacity: 0; } to { transform: scale(1) translate(-50%, -50%); opacity: 1; } }
    @keyframes zoomOut { from { transform: scale(1.4) translate(-50%, -50%); opacity: 0; } to { transform: scale(1) translate(-50%, -50%); opacity: 1; } }

    .zoomIn { animation: zoomIn 1s forwards; }
    .zoomOut { animation: zoomOut 1s forwards; }

    @keyframes flip {
      from { transform: rotateY(90deg) translate(-50%, -50%); opacity: 0; }
      to { transform: rotateY(0deg) translate(-50%, -50%); opacity: 1; }
    }
    .flip { animation: flip 1s forwards; }

    @keyframes rotate {
      from { transform: rotate(90deg) translate(-50%, -50%); opacity: 0; }
      to { transform: rotate(0deg) translate(-50%, -50%); opacity: 1; }
    }
    .rotate { animation: rotate 1s forwards; }

    @keyframes blurIn {
      from { filter: blur(20px); opacity: 0; }
      to { filter: blur(0px); opacity: 1; }
    }
    .blur { animation: blurIn 1s forwards; }

    #fsBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 9999;
      background: #2196f3;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    #fsBtn:hover {
      background: #1e88e5;
    }
  </style>
</head>
<body>
  <div id="cueDisplay"></div>
  <button id="fsBtn" onclick="toggleFullscreen()">Fullscreen</button>

  <script>
    const cueDisplay = document.getElementById("cueDisplay");
    let lastEl = null;

    function clearOldMedia() {
      if (lastEl) {
        lastEl.remove();
        lastEl = null;
      }
    }

    function showCue(data) {
      const isVideo = data.cue.endsWith(".mp4");
      const newEl = document.createElement(isVideo ? "video" : "img");
      newEl.classList.add("media");
      newEl.src = data.cue;

      if (isVideo) {
        newEl.autoplay = data.autoplay ?? true;
        newEl.loop = data.loop ?? true;
        newEl.muted = true;
        newEl.playsInline = true;
        newEl.preload = "auto";
        newEl.addEventListener("canplay", () => newEl.play());
      }

      // Special: blackout cue
      if (data.blackout) {
        const blackout = document.createElement("div");
        blackout.style.background = "black";
        blackout.style.position = "absolute";
        blackout.style.top = "0";
        blackout.style.left = "0";
        blackout.style.width = "100%";
        blackout.style.height = "100%";
        blackout.style.opacity = "0";
        blackout.style.transition = "opacity 1s ease-in-out";
        blackout.style.zIndex = 10;
        cueDisplay.appendChild(blackout);
        requestAnimationFrame(() => blackout.style.opacity = "1");
        return;
      }

      cueDisplay.appendChild(newEl);

      // Prepare dissolve (crossfade)
      if (data.transition === "dissolve" && lastEl) {
        newEl.style.transition = "opacity 1s ease-in-out";
        lastEl.style.transition = "opacity 1s ease-in-out";
        lastEl.style.zIndex = 1;
        newEl.style.zIndex = 2;
        newEl.style.opacity = 0;

        requestAnimationFrame(() => {
          newEl.style.opacity = 1;
          lastEl.style.opacity = 0;
        });

        setTimeout(() => {
          clearOldMedia();
          lastEl = newEl;
        }, 1000);
        return;
      }

      // Other transitions
      const transition = data.transition || "fade2";
      newEl.classList.add("active");

      switch (transition) {
        case "fade2":
        case "fade5":
          newEl.classList.add(transition);
          break;
        case "cut":
          newEl.style.transition = "none";
          newEl.style.opacity = "1";
          break;
        default:
          newEl.classList.add(transition);
      }

      // Remove previous element after animation ends
      if (lastEl) {
        setTimeout(() => {
          clearOldMedia();
        }, 1000);
      }

      lastEl = newEl;
    }

    window.addEventListener("message", (event) => {
      showCue(event.data);
    });

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        document.getElementById("fsBtn").style.display = "none";
      } else {
        document.exitFullscreen();
      }
    }
  </script>
</body>
</html>
