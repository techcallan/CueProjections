<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Viewer</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      background: black;
      overflow: hidden;
    }
    #cueDisplay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: black;
    }
    #cueDisplay img, #cueDisplay video, #cueDisplay div {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      position: absolute;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .fade-in-2s {
      transition: opacity 2s ease;
    }
    .fade-in-5s {
      transition: opacity 5s ease;
    }
    .slide-in {
      transform: translateX(100%);
      animation: slideIn 1s forwards;
    }
    @keyframes slideIn {
      to {
        transform: translateX(0);
      }
    }
    .active {
      opacity: 1;
      z-index: 1;
    }
  </style>
</head>
<body>
  <div id="cueDisplay"></div>

  <script>
    const cueDisplay = document.getElementById("cueDisplay");

    function clearDisplay(callback) {
      const children = [...cueDisplay.children];
      if (!children.length) return callback?.();

      children.forEach(el => {
        el.classList.remove("active");
        el.style.opacity = 0;
        el.style.zIndex = 0;

        if (el.tagName === "VIDEO") {
          el.pause();
          el.removeAttribute("src");
          el.load();
        }

        setTimeout(() => {
          if (el.parentNode === cueDisplay) cueDisplay.removeChild(el);
        }, 1000); // allow transition to finish
      });

      setTimeout(() => callback?.(), 1000);
    }

    function applyTransition(el, type) {
      el.style.zIndex = 1;

      switch (type) {
        case 'fade2':
          el.classList.add('fade-in-2s');
          break;
        case 'fade5':
          el.classList.add('fade-in-5s');
          break;
        case 'slide':
          el.classList.add('slide-in');
          break;
        case 'cut':
          el.style.transition = "none";
          break;
        case 'dissolve':
          el.style.transition = "opacity 1s ease-in-out";
          break;
      }

      requestAnimationFrame(() => {
        el.classList.add("active");
      });
    }

    function showCue(data) {
      clearDisplay(() => {
        if (data.blackout) {
          const blackout = document.createElement("div");
          blackout.style.background = "black";
          blackout.style.width = "100%";
          blackout.style.height = "100%";
          blackout.style.position = "absolute";
          blackout.style.opacity = "0";
          blackout.style.transition = "opacity 2s ease";
          cueDisplay.appendChild(blackout);
          requestAnimationFrame(() => {
            blackout.style.opacity = "1";
            blackout.classList.add("active");
          });
          return;
        }

        const isVideo = data.cue.endsWith(".mp4");
        const el = isVideo ? document.createElement("video") : document.createElement("img");
        el.src = data.cue;

        el.style.position = "absolute";
        el.style.top = "50%";
        el.style.left = "50%";
        el.style.transform = "translate(-50%, -50%)";

        if (isVideo) {
          el.autoplay = data.autoplay ?? true;
          el.loop = data.loop ?? true;
          el.muted = true;
          el.playsInline = true;
          el.preload = "auto";
          el.addEventListener("canplay", () => {
            el.play();
            applyTransition(el, data.transition);
          });
        } else {
          el.onload = () => applyTransition(el, data.transition);
        }

        cueDisplay.appendChild(el);
      });
    }

    window.addEventListener("message", (event) => {
      if (event.data?.cue || event.data?.blackout) {
        showCue(event.data);
      }
    });
  </script>
</body>
</html>
